version: 2.1

executors:
  default:
    docker:
      - image: circleci/node

jobs:
  clear-cache:
    executor: default
    environment:
      DIRECTORY: _site
      BRNACH: gh-pages
    steps:
      - checkout
      - run: |
          #!/bin/bash
          build_command() {
            jekyll build
          }

          git fetch origin gh-pages

          echo -e "\033[0;32mDeleting old content...\033[0m"
          rm -rf $DIRECTORY

          echo -e "\033[0;32mChecking out $BRNACH....\033[0m"
          git worktree add $DIRECTORY $BRNACH

          echo -e "\033[0;32mGenerating site...\033[0m"
          build_command

          echo -e "\033[0;32mDeploying $BRNACH branch...\033[0m"
          cd $DIRECTORY &&
            git add --all &&
            git commit -m "Deploy updates" &&
            git push origin $BRNACH

      - run: |
          set -e
          curl -X POST "https://api.cloudflare.com/client/v4/zones/$CF_ZONE/purge_cache" \
              -H "X-Auth-Email: $CF_EMAIL" \
              -H "X-Auth-Key: $CF_KEY" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}'

workflows:
  clear-cache:
    jobs:
      - clear-cache
