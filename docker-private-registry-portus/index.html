<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Host your own private docker registry with Portus – MrPowerScripts – Learn. Code. Grow.</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>
    <link rel="canonical" href="https://mrpowerscripts.com/docker-private-registry-portus/">

    
    <meta name="description" content="If you're familiar with docker then you've probably used DockerHub. Dockerhub is AWESOME. I absolutely love (most) of it and what it does. DockerHub is simply a docker container registry. It's a place where you can store, pull, and share docker containers. It's not the only container registry. Google has their own container registry where you can upload your images. Microsoft and Amazon also have docker container registries. All of that is great, but what if you want to host your won docker images in a private registry. Those registries I mentioned have support for private accounts, but I'm going to reveal how you can host your own private container registry that you control." />
    <meta property="og:description" content="If you're familiar with docker then you've probably used DockerHub. Dockerhub is AWESOME. I absolutely love (most) of it and what it does. DockerHub is simply a docker container registry. It's a place where you can store, pull, and share docker containers. It's not the only container registry. Google has their own container registry where you can upload your images. Microsoft and Amazon also have docker container registries. All of that is great, but what if you want to host your won docker images in a private registry. Those registries I mentioned have support for private accounts, but I'm going to reveal how you can host your own private container registry that you control." />
    
    <meta name="author" content="MrPowerScripts" />

    
    <meta property="og:title" content="Host your own private docker registry with Portus" />
    <meta property="twitter:title" content="Host your own private docker registry with Portus" />
    

    
    <meta content="/images/mpslogo.png" property="og:image">
    

    
        
    <meta content="mrpowerscripts" property="article:tag">
        
    <meta content="private Docker registry" property="article:tag">
        
    <meta content="setup docker registry" property="article:tag">
        
    <meta content="set up private Docker registry" property="article:tag">
        
    

    <link rel="apple-touch-icon" sizes="57x57" href="/images/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/images/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/images/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/images/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/images/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/images/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/images/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/images/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/images/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
<link rel="manifest" href="/images/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/images/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="MrPowerScripts - Learn. Code. Grow." href="/feed.xml" />


    <meta name="google-site-verification" content="prYTc9sgHOxJOubz6hLVkkfpea2I82I0UfoePeJ_FEg" />
    <meta name="msvalidate.01" content="5518FAB6C86578E1F5002CD56C1B5F24" />
    <meta name="yandex-verification" content="4539896b000a5ed9" />
    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->

    
    
        <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Host your own private docker registry with Portus",
        "description": "If you're familiar with docker then you've probably used DockerHub. Dockerhub is AWESOME. I absolutely love (most) of it and what it does. DockerHub is simply a docker container registry. It's a place where you can store, pull, and share docker containers. It's not the only container registry. Google has their own container registry where you can upload your images. Microsoft and Amazon also have docker container registries. All of that is great, but what if you want to host your won docker images in a private registry. Those registries I mentioned have support for private accounts, but I'm going to reveal how you can host your own private container registry that you control.",
        "image": [
            
                "https://mrpowerscripts.com/images/twilightyellow.png"
            
        ],
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https://mrpowerscripts.com/docker-private-registry-portus/"
        },
        "datePublished": "2019-01-01 09:06:45 +0000",
        "dateModified": "2019-01-01 09:06:45 +0000",
        "isAccessibleForFree": "True",
        "isPartOf": {
            "@type": ["CreativeWork", "Product", "Blog"],
            "name": "MrPowerScripts",
            "productID": ""
        },
        "license": "http://creativecommons.org/licenses/by-sa/4.0/",
        "author": {
            "@type": "Person",
            "name": "MrPowerScripts",
            "description": "MrPowerScripts is here to help you automate your life so you have more time for automating your life. 
My youtube channel started as a way for me to share stuff I was learning about Powershell. That was in 2012, and 
since then the channel and grown in many different ways as my career and skills have envolved. My new goal with the channel
is to try and automate it entirely. I'll be sharing a lot about that journey of automation while continuing 
other porjects and sharing them here on my blog as well as youtube. Join my on Discord if you have any questions.
",
            "sameAs": "https://mrpowerscripts.com/about",
            "image": {
                "@type": "ImageObject",
                "url": "https://mrpowerscripts.com/images/twilightyellow.png"
            },
            "givenName": "",
            "familyName": "",
            "alternateName": "MrPowerScripts",
            "publishingPrinciples": "https://mrpowerscripts.com/about/"
        },
        "publisher": {
            "@type": "Organization",
            "name": "MrPowerScripts",
            "description": "MrPowerScripts is here to help you automate your life so you have more time for automating your life. 
My youtube channel started as a way for me to share stuff I was learning about Powershell. That was in 2012, and 
since then the channel and grown in many different ways as my career and skills have envolved. My new goal with the channel
is to try and automate it entirely. I'll be sharing a lot about that journey of automation while continuing 
other porjects and sharing them here on my blog as well as youtube. Join my on Discord if you have any questions.
",
            "sameAs": "https://mrpowerscripts.com",
            "logo": {
                "@type": "ImageObject",
                "url": "https://mrpowerscripts.com/images/twilightyellow.png"
            },
            "publishingPrinciples": "https://mrpowerscripts.com/about/"
        }
    }
</script>
    
      
  </head>

  <body>
    <div class="wrapper-masthead">
      <div id='stars'></div>
      <div id='stars2'></div>
      <div id='stars3'></div>
      <div class="container">
        <header class="masthead">
          <a href="/" class="site-avatar"><img src="https://mrpowerscripts.com/images/twilightyellow.png" alt="site avatar" /></a>

          <div class="site-info">
            <h2 class="site-name"><a href="/">MrPowerScripts</a></h2>
            <p class="site-description">Learn. Code. Grow.</p>
          </div>

          <nav>
            <a onclick="selectRandom()">Random</a>
            <!-- <a href="/podcast">Podcast</a> -->
            <a href="http://bit.ly/mrps-discord">Discord</a>
            <!-- <a href="/about">About</a> -->
            <a href="/power-up" class="power-up">Power Up</a>
          </nav>

        </header>
        <!-- <div class="meta-links">
            
<a href="mailto:playingwithpowershell@gmail.com">e-mail</a> |


<a href="https://github.com/mrpowerscripts">github</a> |



<a href="/feed.xml">rss</a> |
<a href="https://www.twitter.com/mrpowerscripts">twitter</a> |

<a href="https://youtube.com/user/mrpowerscripts">youtube</a> |

<a href="https://discord.gg/uEBWZKq">discord</a> |
<a href="https://patreon.com/mrpowerscripts">patreon</a>

<style>
.meta-links {
    display: flex;
    color: white;
    justify-content: space-around;
}

.meta-links a {
  color: white;
  padding: 0px 0px;
}

.meta-links a:hover {
  color:purple;
}
</style>
        </div> -->
        <!-- 
<div id="share-bar">

  <h4>Share this:</h4>

  <div class="share-buttons">
      <a  href="https://www.facebook.com/sharer/sharer.php?u=https://mrpowerscripts.com/docker-private-registry-portus/"
          onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
          title="Share on Facebook" >
          <i class="fa fa-facebook-official share-button"> facebook</i>
      </a>

      <a  href="https://twitter.com/intent/tweet?text=Host your own private docker registry with Portus&url=https://mrpowerscripts.com/docker-private-registry-portus/"
          onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
          title="Share on Twitter" >
          <i class="fa fa-twitter share-button"> twitter</i>
      </a>

      <a  href="http://www.tumblr.com/share/link?url=https://mrpowerscripts.com/docker-private-registry-portus/"
          onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;"
          title="Share on Tumblr" >
          <i class="fa fa-tumblr share-button"> tumblr</i>
      </a>

      <a  href="http://www.reddit.com/submit?url=https://mrpowerscripts.com/docker-private-registry-portus/"
          onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;"
          title="Share on Reddit" >
          <i class="fa fa-reddit-alien share-button"> reddit</i>
      </a>

      <a  href="https://www.linkedin.com/shareArticle?mini=true&url=https://mrpowerscripts.com/docker-private-registry-portus/&title=Host your own private docker registry with Portus&summary=&source="
          onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
          title="Share on LinkedIn" >
          <i class="fa fa-linkedin share-button"> linkedin</i>
      </a>

      <a  href="mailto:?subject=Host your own private docker registry with Portus&amp;body=Check out this site https://mrpowerscripts.com/docker-private-registry-portus/"
          title="Share via Email" >
          <i class="fa fa-envelope share-button"> email</i>
      </a>
  </div>

</div> let's hide this until it looks pretty-->
      </div>
    </div>

    <div id="main" role="main" class="container">
      <!-- <div id="active-motions" class="active-motions">
  <h3>Active Discord Votes</h3>
  <div class="active-motion-list" id="active-motion-list"></div>
</div>

<script>
function isMRPS(messageID) {
  if (parseInt(messageID) === 510819339411390474) {
    // console.log('motion is mine')
    return true
  } else {
    // console.log('motion is not mine')
    return false
  }
}

window.addEventListener('load', function() {
  fetch("http://dr.mrpowerscripts.com:8888/motionsData.json")
  .then(res => res.json())
  .then(out => {
    window.motions = out.motions
    var motions = out.motions.filter(i => isMRPS(i.author)).slice(0, 3)
    // console.log(motions)
    
    var activeMotionList = document.getElementById("active-motion-list")

    for (var i = 0; i < motions.length; i++) {
      var motion = document.createElement('a')

      motion.href = `https://discordapp.com/channels/510821302773219331/534510417448402965/${motions[i].msg}`
      motion.target = '_blank'
      motion.innerHTML = `⚈ ${motions[i].text}`
      activeMotionList.appendChild(motion);
    }

    if (motions.length) {
      document.getElementById("active-motions").style.height = "100%"
      document.getElementById("active-motions").style.opacity = "1"
    }
  })
}, false);
</script> -->
<article class="post">
  <h1>Host your own private docker registry with Portus</h1>
  <div class="post-menu-bar">
    <span>👤MrPowerScripts</span>
    <span>📅 January 01, 2019</span>
    <span class="reading-time" title="Estimated read time">
  
  
  ⌛10 mins
  
</span>

<!-- 
Genius https://carlosbecker.com/posts/jekyll-reading-time-without-plugins/ 
Double genius https://scottdorman.github.io/2017/07/09/adding-reading-time-to-blog-posts/
-->

    <a class="edit-button" href="/tree/master/_posts/2019-01-01-docker-private-registry-portus.md">Edit</a>
  </div>
  <hr>
  <div class="entry">
    <p>If you’re familiar with docker then you’ve probably used DockerHub. Dockerhub is AWESOME. I absolutely love (most of) it and what it does. DockerHub is simply a docker container registry. It’s a place where you can store, pull, and share docker containers. <!-- (1) video wrapper --></p>
<div class="youtube-video" data-embed="gvaRfAqCfGY"> 
 
    <!-- (2) the "play" button -->
    <div class="play-button"></div> 
     
</div>
<p>It’s not the only container registry. Google has their own container registry where you can upload your images. Microsoft and Amazon also have docker container registries. All of that is great, but what if you want to host your won docker images in a private registry. Those registries I mentioned have support for private accounts, but I’m going to reveal how you can host your own private container registry that you control.</p>

<p>Want to automate this whole configuration process? I have a script that will set all of this up in 10 minutes! With some extra configuration that is very useful for a first install. You can <a href="http://bit.ly/mrps-portus-registry">find a link to the script here</a> or at the bottom of the page. Enjoy!</p>

<p>Two requirements:</p>

<ul>
  <li>A domain name</li>
  <li>A server</li>
</ul>

<p>The server is simple. I used at $10 Ubuntu 18.10 droplet on Digital Ocean configured with SSH access. Though it should work for 18.04 as well. When you can SSH into your server you’re ready for the next step</p>

<p>I’m sure you want to login to your docker registry using the docker client locally - as you do with DockerHub. In order for that to happen, there must be a secured connection between you and the registry (your server). Else docker will throw a fit and require all kinds of hacks to get things working.</p>

<p>So, you’re going to need an SSL certificate from a trusted certifitate authority. We’re going to use <a href="https://letsencrypt.org">LetsEncrypt</a> because it’s free and can be automated. I used <a href="https://www.humankode.com/ssl/how-to-set-up-free-ssl-certificates-from-lets-encrypt-using-docker-and-nginx">this blog post</a> to get my SSL cert on the server.  It explains everything you’ll need to make sure your domain is configured properly for secured connections.</p>

<p>Once you have your domain configured properly and the SSL certificate is on the server you can start configuring the registry. Docker themselves maintains and releases <a href="https://hub.docker.com/_/registry/">a docker image</a> that is a Docker registry. Yea, they put a docker container registry in a docker container. But there’s one problem. There’s no GUI. There’s no access control. It’s not that exciting by itself. If only there was some open source project built off this registry container that had all the cool bells and whistles included. Oh, right, there is. <a href="https://github.com/SUSE/Portus">Portus</a>.</p>

<p>Portus is amazing. I’ll go over the Portus UI in the video, but it does basically everything you could want it to do. You can create accounts, teams, and namespaces. You can add access controls to make images private, private to logged in users, or public for anyone on the internet to use. The UI is very clean and well organized.</p>

<p>This <a href="https://www.objectif-libre.com/en/blog/2018/06/11/self-hosting-a-secure-docker-registry-with-portus/">blog post</a> put me in the right direction to configure Portus and get it running. Thankfully they have a <code class="highlighter-rouge">docker-compose.yml</code> file that can be used which spins up all the services.</p>

<p>After modifying the <code class="highlighter-rouge">docker-compose.yml</code> from the blog article to use my own SSL certificate, and extra little config changes here and there to improve the experience, the Portus server is live!</p>

<p>Now I’m able to <code class="highlighter-rouge">docker login</code> into my own secure private Docker registry where I can manage and share access to images.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c">###                                                                                     ##</span>
<span class="c">### This script will turn an Ubuntu 18.04/10 server into a docker registry with a GUI   ##</span>
<span class="c">###                                                                                     ##</span>

<span class="c">## MrPowerScripts ##</span>
<span class="c"># Website: https://MrPowerScripts.com</span>
<span class="c"># Discord: https://bit.ly/mrps-discord</span>
<span class="c"># Patreon: https://bit.ly/mrps-patreon</span>
<span class="c"># Sign up: https://bit.ly/mrps-mail-list</span>
<span class="c"># Twitter: https://bit.ly/mrps-twitter</span>

<span class="c"># This script was created thanks to a number of guides and other peoples efforts. Please check them out!</span>
<span class="c"># https://www.objectif-libre.com/en/blog/2018/06/11/self-hosting-a-secure-docker-registry-with-portus/</span>
<span class="c"># https://www.humankode.com/ssl/how-to-set-up-free-ssl-certificates-from-lets-encrypt-using-docker-and-nginx</span>

<span class="c"># THis script is intended to be run on ubuntu 18.04 or 18.10. You must run it from the home directory (~).</span>
<span class="c"># I was able to run the box fine on a $10 droplet from digital ocean.</span>
<span class="c"># It will provision the enviroment, install an ssl cert from letsencrypt, and start the Portus registry service.</span>
<span class="c"># You can login to your new docker registry at https://${your_domain}:3000.</span>
<span class="c"># You WILL NOT be able to connect through http. You must prefix your URL with HTTPS.</span>
<span class="c"># You will be asked to create an admin account on first visit. If you have any issues join my Discord server.</span>

<span class="c"># After you have the server set up you can create other user account, or use the admin account.</span>
<span class="c"># You will be able to login to your private registry using the docker client by pointing it to your domain.</span>
<span class="c"># ex. docker login forestfiles.com</span>

<span class="c"># From here you can interact with your private registry to push and pull images as you would on DockerHub.</span>

<span class="c"># =====!!!!!!! IMPORTANT !!!!!!!=====</span>
<span class="c"># Make sure to set these values.</span>
<span class="c"># If your server is on a subdomain (sub.forestfiles.com) that's fine</span>
<span class="c"># The domain must be set up with a properly configured A Record that points to the server IP.</span>
<span class="c"># You cannot use an IP address with this configuration. You must have a domain name.</span>
<span class="nv">DOMAIN</span><span class="o">=</span><span class="s2">"forestfiles.com"</span>
<span class="nv">EMAIL</span><span class="o">=</span><span class="s2">"email@gmail.com"</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$DOMAIN</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"forestfiles.com"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"you forgot to change the domain"</span>
  <span class="nb">exit
</span><span class="k">elif</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$EMAIL</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"email@gmail.com"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"you forgot to change the email"</span>
  <span class="nb">exit
</span><span class="k">fi</span>

<span class="c"># We'll use this later</span>
<span class="nv">UBUNTU</span><span class="o">=</span><span class="si">$(</span> lsb_release <span class="nt">-r</span> | <span class="nb">awk</span> <span class="s1">'{ print $2 }'</span> | <span class="nb">sed</span> <span class="s1">'s/[.]//'</span> <span class="si">)</span>
<span class="nb">sudo </span>apt-get update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get <span class="nb">install </span>jq <span class="nt">-y</span>


<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$UBUNTU</span><span class="s2">"</span> <span class="o">==</span> 1804 <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="c"># Install Docker Normally</span>
  <span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="se">\</span>
      apt-transport-https <span class="se">\</span>
      ca-certificates <span class="se">\</span>
      curl <span class="se">\</span>
      software-properties-common <span class="nt">-y</span>
  curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg | <span class="nb">sudo </span>apt-key add -
  <span class="nb">sudo </span>add-apt-repository <span class="se">\</span>
    <span class="s2">"deb [arch=amd64] https://download.docker.com/linux/ubuntu </span><span class="se">\</span><span class="s2">
    </span><span class="si">$(</span>lsb_release <span class="nt">-cs</span><span class="si">)</span><span class="s2"> </span><span class="se">\</span><span class="s2">
    stable"</span> <span class="nt">-y</span>
  <span class="nb">sudo </span>apt-get update <span class="nt">-y</span>
  <span class="nb">sudo </span>apt-get <span class="nb">install </span>docker-ce <span class="nt">-y</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$UBUNTU</span><span class="s2">"</span> <span class="o">==</span> 1810 <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="c"># Install docker 18.10 - this is before they had a release for this version. hack required</span>
  <span class="nb">sudo </span>apt <span class="nb">install </span>apt-transport-https ca-certificates curl software-properties-common <span class="nt">-y</span>
  curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg | <span class="nb">sudo </span>apt-key add -
  <span class="nb">sudo </span>add-apt-repository <span class="s2">"deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic test"</span> <span class="nt">-y</span>
  <span class="nb">sudo </span>apt <span class="nb">install </span>docker-ce <span class="nt">-y</span>
<span class="k">else
 </span><span class="nb">echo</span> <span class="s2">"This script was meant to be run on at least Ubuntu 18.04"</span>
 <span class="nb">exit
</span><span class="k">fi</span>

<span class="c"># Install docker compose</span>
<span class="nb">sudo </span>curl <span class="nt">-L</span> <span class="s2">"https://github.com/docker/compose/releases/download/1.21.2/docker-compose-</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-s</span><span class="si">)</span><span class="s2">-</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="nt">-o</span> /usr/local/bin/docker-compose
<span class="nb">sudo chmod</span> +x /usr/local/bin/docker-compose

<span class="c"># Install Portus</span>
<span class="nb">rm</span> <span class="nt">-rf</span> /tmp/portus
git clone https://github.com/SUSE/Portus.git /tmp/portus
<span class="nb">mv</span> /tmp/portus/examples/compose ./portus

<span class="c"># Edit the portus files for our domain and SSL</span>
<span class="o">(</span>
<span class="nb">cd </span>portus <span class="o">||</span> <span class="nb">exit
</span>docker-compose down <span class="nt">-v</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/172.17.0.1/</span><span class="k">${</span><span class="nv">DOMAIN</span><span class="k">}</span><span class="s2">/g"</span> .env
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/172.17.0.1/</span><span class="k">${</span><span class="nv">DOMAIN</span><span class="k">}</span><span class="s2">/g"</span> nginx/nginx.conf
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/portus.crt/fullchain.pem/g"</span> nginx/nginx.conf
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/portus.key/privkey.pem/g"</span> nginx/nginx.conf
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/portus.crt/fullchain.pem/g"</span> registry/init
<span class="nb">rm </span>docker-compose.<span class="k">*</span>
<span class="o">)</span>

<span class="c"># We're getting all the config files into the right place</span>
<span class="nb">sudo mkdir</span> <span class="nt">-p</span> /docker/letsencrypt-docker-nginx/src/letsencrypt/letsencrypt-site
<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="sh">'</span><span class="no">EOF</span><span class="sh">' &gt; ./portus/docker-compose.yml
version: "2"

services:
  portus:
    image: opensuse/portus:head
    environment:
      - PORTUS_MACHINE_FQDN_VALUE=</span><span class="k">${</span><span class="nv">MACHINE_FQDN</span><span class="k">}</span><span class="sh">
      - PORTUS_SECURITY_CLAIR_SERVER=http://clair:6060

      # DB. The password for the database should definitely not be here. You are
      # probably better off with Docker Swarm secrets.
      - PORTUS_DB_HOST=db
      - PORTUS_DB_DATABASE=PORTUS_production
      - PORTUS_DB_PASSWORD=</span><span class="k">${</span><span class="nv">DATABASE_PASSWORD</span><span class="k">}</span><span class="sh">
      - PORTUS_DB_POOL=5

      # Secrets. It can possibly be handled better with Swarm's secrets.
      - PORTUS_SECRET_KEY_BASE=</span><span class="k">${</span><span class="nv">SECRET_KEY_BASE</span><span class="k">}</span><span class="sh">
      - PORTUS_KEY_PATH=/certificates/privkey.pem
      - PORTUS_PASSWORD=</span><span class="k">${</span><span class="nv">PORTUS_PASSWORD</span><span class="k">}</span><span class="sh">

      # SSL
      - PORTUS_PUMA_TLS_KEY=/certificates/privkey.pem
      - PORTUS_PUMA_TLS_CERT=/certificates/fullchain.pem

      # NGinx is serving the assets instead of Puma. If you want to change this,
      # uncomment this line.
      - RAILS_SERVE_STATIC_FILES=true

      # Other Config
      #- PORTUS_SIGNUP_ENABLED=false
      - PORTUS_ANONYMOUS_BROWSING_ENABLED=false
      - PORTUS_DELETE_ENABLED=true
    ports:
      - 3000:3000
    links:
      - db
    volumes:
      - ./secrets:/certificates:ro
      #- ./static:/srv/Portus/public

  background:
    image: opensuse/portus:head
    depends_on:
      - portus
      - db
    environment:
      # Theoretically not needed, but cconfig's been buggy on this...
      - CCONFIG_PREFIX=portus
      - PORTUS_MACHINE_FQDN_VALUE=</span><span class="k">${</span><span class="nv">MACHINE_FQDN</span><span class="k">}</span><span class="sh">
      - PORTUS_SECURITY_CLAIR_SERVER=http://clair:6060

      # DB. The password for the database should definitely not be here. You are
      # probably better off with Docker Swarm secrets.
      - PORTUS_DB_HOST=db
      - PORTUS_DB_DATABASE=PORTUS_production
      - PORTUS_DB_PASSWORD=</span><span class="k">${</span><span class="nv">DATABASE_PASSWORD</span><span class="k">}</span><span class="sh">
      - PORTUS_DB_POOL=5

      # Secrets. It can possibly be handled better with Swarm's secrets.
      - PORTUS_SECRET_KEY_BASE=</span><span class="k">${</span><span class="nv">SECRET_KEY_BASE</span><span class="k">}</span><span class="sh">
      - PORTUS_KEY_PATH=/certificates/privkey.pem
      - PORTUS_PASSWORD=</span><span class="k">${</span><span class="nv">PORTUS_PASSWORD</span><span class="k">}</span><span class="sh">

      - PORTUS_BACKGROUND=true
      - PORTUS_SYNC_ENABLED=true
      - PORTUS_SYNC_STRATEGY=update-delete
    links:
      - db
    volumes:
      #- ./secrets:/certificates:ro
      - /etc/letsencrypt/live/dr.mrpowerscripts.com:/certificates

  db:
    image: library/mariadb:10.0.23
    command: mysqld --character-set-server=utf8 --collation-server=utf8_unicode_ci --init-connect='SET NAMES UTF8;' --innodb-flush-log-at-trx-commit=0
    environment:
      - MYSQL_DATABASE=PORTUS_production

      # Again, the password shouldn't be handled like this.
      - MYSQL_ROOT_PASSWORD=</span><span class="k">${</span><span class="nv">DATABASE_PASSWORD</span><span class="k">}</span><span class="sh">
    volumes:
      - ./mariadb:/var/lib/mysql

  registry:
    image: library/registry:2.6
    command: ["/bin/sh", "/etc/docker/registry/init"]
    environment:
      # Authentication
      REGISTRY_AUTH_TOKEN_REALM: https://</span><span class="k">${</span><span class="nv">MACHINE_FQDN</span><span class="k">}</span><span class="sh">/v2/token
      REGISTRY_AUTH_TOKEN_SERVICE: </span><span class="k">${</span><span class="nv">MACHINE_FQDN</span><span class="k">}</span><span class="sh">:5000
      REGISTRY_AUTH_TOKEN_ISSUER: </span><span class="k">${</span><span class="nv">MACHINE_FQDN</span><span class="k">}</span><span class="sh">
      REGISTRY_AUTH_TOKEN_ROOTCERTBUNDLE: /secrets/fullchain.pem

      # SSL
      REGISTRY_HTTP_TLS_CERTIFICATE: /secrets/fullchain.pem
      REGISTRY_HTTP_TLS_KEY: /secrets/privkey.pem

      # portus endpoint
      REGISTRY_NOTIFICATIONS_ENDPOINTS: &gt;
        - name: portus
          url: https://</span><span class="k">${</span><span class="nv">MACHINE_FQDN</span><span class="k">}</span><span class="sh">/v2/webhooks/events
          timeout: 2000ms
          threshold: 5
          backoff: 1s
    volumes:
      - ./secrets:/usr/local/share/ca-certificates:ro
      - ./registry/data:/var/lib/registry
      - ./secrets:/secrets:ro
      - ./registry/config.yml:/etc/docker/registry/config.yml:ro
      - ./registry/init:/etc/docker/registry/init:ro
    ports:
      - 5000:5000
      - 5001:5001 # required to access debug service
    links:
      - portus:portus

  postgres:
    image: library/postgres:10-alpine
    environment:
      POSTGRES_PASSWORD: portus

  clair:
    image: quay.io/coreos/clair
    restart: unless-stopped
    depends_on:
      - postgres
    links:
      - postgres
      - portus
    ports:
      - "6060-6061:6060-6061"
    volumes:
      - /tmp:/tmp
      - ./clair/clair.yml:/clair.yml
    command: [-config, /clair.yml]


  nginx:
    image: library/nginx:alpine
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./secrets:/secrets:ro
      - static:/srv/Portus/public:ro
    ports:
      - 80:80
      - 443:443
    links:
      - registry:registry
      - portus:portus


volumes:
  static:
</span><span class="no">EOF

</span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; /docker/letsencrypt-docker-nginx/src/letsencrypt/docker-compose.yml
version: '3.1'

services:

  letsencrypt-nginx-container:
    container_name: 'letsencrypt-nginx-container'
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - ./letsencrypt-site:/usr/share/nginx/html
    networks:
      - docker-network

networks:
  docker-network:
    driver: bridge
</span><span class="no">EOF

</span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; /docker/letsencrypt-docker-nginx/src/letsencrypt/nginx.conf
server {
    listen 80;
    listen [::]:80;
    server_name </span><span class="k">${</span><span class="nv">DOMAIN</span><span class="k">}</span><span class="sh">.com www.</span><span class="k">${</span><span class="nv">DOMAIN</span><span class="k">}</span><span class="sh">.com;

    location ~ /.well-known/acme-challenge {
        allow all;
        root /usr/share/nginx/html;
    }

    root /usr/share/nginx/html;
    index index.html;
}
</span><span class="no">EOF

</span><span class="c"># Bring up the nginx webserver to get the letsencrypt certs</span>
<span class="nb">cd</span> /docker/letsencrypt-docker-nginx/src/letsencrypt <span class="o">||</span> <span class="nb">exit
sudo </span>docker-compose up <span class="nt">-d</span> <span class="o">||</span> <span class="nb">exit

sleep </span>5

<span class="c"># Now we're getting the real cert here</span>
<span class="nb">sudo </span>docker run <span class="nt">--rm</span> <span class="se">\</span>
  <span class="nt">-v</span> /docker-volumes/etc/letsencrypt:/etc/letsencrypt <span class="se">\</span>
  <span class="nt">-v</span> /docker-volumes/var/lib/letsencrypt:/var/lib/letsencrypt <span class="se">\</span>
  <span class="nt">-v</span> /docker/letsencrypt-docker-nginx/src/letsencrypt/letsencrypt-site:/data/letsencrypt <span class="se">\</span>
  <span class="nt">-v</span> <span class="s2">"/docker-volumes/var/log/letsencrypt:/var/log/letsencrypt"</span> <span class="se">\</span>
  certbot/certbot <span class="se">\</span>
  certonly <span class="nt">--webroot</span> <span class="se">\</span>
  <span class="nt">--email</span> <span class="s2">"</span><span class="k">${</span><span class="nv">EMAIL</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--agree-tos</span> <span class="nt">--no-eff-email</span> <span class="se">\</span>
  <span class="nt">--webroot-path</span><span class="o">=</span>/data/letsencrypt <span class="se">\</span>
  <span class="nt">-d</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DOMAIN</span><span class="k">}</span><span class="s2">"</span>

<span class="c"># Copy our new cert to the portus secrets folder</span>
<span class="nb">cp</span> /docker-volumes/etc/letsencrypt/live/<span class="s2">"</span><span class="k">${</span><span class="nv">DOMAIN</span><span class="k">}</span><span class="s2">"</span>/<span class="k">*</span> ~/portus/secrets


<span class="c"># Shutdown the letsencrypt webserver</span>
<span class="nb">cd</span> /docker/letsencrypt-docker-nginx/src/letsencrypt <span class="o">||</span> <span class="nb">exit
sudo </span>docker-compose down

<span class="nb">cd</span> ~/portus <span class="o">||</span> <span class="nb">exit

</span>docker-compose up <span class="nt">-d</span> <span class="nt">--force-recreate</span>

<span class="c"># ----------- this is all stuff to do a self signed cert</span>
<span class="c"># Yuu have to do all kinda of weird client side stuff to connect to self signed certs tho</span>
<span class="c"># echo "subjectAltName = URI:${DOMAIN}" &gt; extfile.cnf</span>
<span class="c"># echo "basicConstraints=CA:FALSE" &gt;&gt; extfile.cnf || exit</span>
<span class="c"># echo "subjectAltName=@my_subject_alt_names" &gt;&gt; extfile.cnf || exit</span>
<span class="c"># echo "subjectKeyIdentifier = hash" &gt;&gt; extfile.cnf || exit</span>
<span class="c"># echo "[ my_subject_alt_names ]" &gt;&gt; extfile.cnf || exit</span>
<span class="c"># echo "DNS.1 = *.${DOMAIN}" &gt;&gt; extfile.cnf || exit</span>

<span class="c"># openssl genrsa -out secrets/rootca.key 2048</span>
<span class="c"># dd if=/dev/urandom of=~/.rnd bs=256 count=1</span>
<span class="c"># openssl req -x509 -new -nodes -key secrets/rootca.key \</span>
<span class="c">#  -subj "/C=US/ST=CA/O=Acme, Inc." \</span>
<span class="c">#  -sha256 -days 1024 -out secrets/rootca.crt</span>

<span class="c"># openssl genrsa -out secrets/portus.key 2048</span>
<span class="c"># openssl req -new -key secrets/portus.key -out secrets/portus.csr \</span>
<span class="c">#  -subj "/C=US/ST=CA/O=Acme, Inc./CN=${DOMAIN}"</span>

<span class="c"># openssl x509 -req -in secrets/portus.csr -CA secrets/rootca.crt -extfile \</span>
<span class="c">#  extfile.cnf -CAkey secrets/rootca.key -CAcreateserial \</span>
<span class="c">#  -out secrets/portus.crt -days 500 -sha256</span>
</code></pre></div></div>

  </div>

  <div class="date">
    Written on January  1, 2019
  </div>
  <hr>
  <div>
  Do you have some thoughts on this article? Come chat about it on <a href="http://bit.ly/mrps-discord">Discord</a>.
  If you enjoy the content <a href="/power-up">check out ways you can support the site</a>.
</div>

  <div id="suggested" class="suggested" hidden>
    <h4>Suggested posts for you</h4>
    <div class="suggested-posts">
      <a href="" class="suggested-post" id="suggested-1"></a>
      <a href="" class="suggested-post" id="suggested-2"></a>
      <a href="" class="suggested-post" id="suggested-3"></a>
      <a href="" class="suggested-post" id="suggested-4"></a>
      <a href="" class="suggested-post" id="suggested-5"></a>
    </div>
  </div>
</article>

<script>

window.addEventListener('load', function() {
  fetch(window.location.origin+"/api.json")
  .then(res => res.json())
  .then(out => {
    var posts = out.sort(() => .5 - Math.random()).slice(0,5)
    let i
    for (i=0; i < posts.length; i++) {
      document.getElementById(`suggested-${i + 1}`).text = posts[i].title
      document.getElementById(`suggested-${i + 1}`).href = posts[i].url
    }

    document.getElementById("suggested").hidden = false
  })
  .catch(error => console.error(error))
}, false);
</script>



    </div>

    <div class="wrapper-footer">
      <div class="container">
        <!-- 
<div id="share-bar">

  <h4>Share this:</h4>

  <div class="share-buttons">
      <a  href="https://www.facebook.com/sharer/sharer.php?u=https://mrpowerscripts.com/docker-private-registry-portus/"
          onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
          title="Share on Facebook" >
          <i class="fa fa-facebook-official share-button"> facebook</i>
      </a>

      <a  href="https://twitter.com/intent/tweet?text=Host your own private docker registry with Portus&url=https://mrpowerscripts.com/docker-private-registry-portus/"
          onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
          title="Share on Twitter" >
          <i class="fa fa-twitter share-button"> twitter</i>
      </a>

      <a  href="http://www.tumblr.com/share/link?url=https://mrpowerscripts.com/docker-private-registry-portus/"
          onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;"
          title="Share on Tumblr" >
          <i class="fa fa-tumblr share-button"> tumblr</i>
      </a>

      <a  href="http://www.reddit.com/submit?url=https://mrpowerscripts.com/docker-private-registry-portus/"
          onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;"
          title="Share on Reddit" >
          <i class="fa fa-reddit-alien share-button"> reddit</i>
      </a>

      <a  href="https://www.linkedin.com/shareArticle?mini=true&url=https://mrpowerscripts.com/docker-private-registry-portus/&title=Host your own private docker registry with Portus&summary=&source="
          onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
          title="Share on LinkedIn" >
          <i class="fa fa-linkedin share-button"> linkedin</i>
      </a>

      <a  href="mailto:?subject=Host your own private docker registry with Portus&amp;body=Check out this site https://mrpowerscripts.com/docker-private-registry-portus/"
          title="Share via Email" >
          <i class="fa fa-envelope share-button"> email</i>
      </a>
  </div>

</div> -->
        <footer class="footer">
          
<a href="mailto:playingwithpowershell@gmail.com">e-mail</a> |


<a href="https://github.com/mrpowerscripts">github</a> |



<a href="/feed.xml">rss</a> |
<a href="https://www.twitter.com/mrpowerscripts">twitter</a> |

<a href="https://youtube.com/user/mrpowerscripts">youtube</a> |

<a href="https://discord.gg/uEBWZKq">discord</a> |
<a href="https://patreon.com/mrpowerscripts">patreon</a>

<style>
.meta-links {
    display: flex;
    color: white;
    justify-content: space-around;
}

.meta-links a {
  color: white;
  padding: 0px 0px;
}

.meta-links a:hover {
  color:purple;
}
</style>
        </footer>
      </div>
    </div>

    
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-121890486-1"></script>
<script>
  if (document.location.hostname.search("mrpowerscripts.com") !== -1) {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-121890486-1');
}
</script>


<script type="text/javascript">var _kmq = _kmq || [];
  var _kmk = _kmk || 'a59a911fe1083dcbd2bc1717206ab09add1eea6a';
  function _kms(u){
    setTimeout(function(){
      var d = document, f = d.getElementsByTagName('script')[0],
      s = d.createElement('script');
      s.type = 'text/javascript'; s.async = true; s.src = u;
      f.parentNode.insertBefore(s, f);
    }, 1);
  }
  _kms('//i.kissmetrics.com/i.js');
  _kms('//scripts.kissmetrics.com/' + _kmk + '.2.js');
  </script>




    <script src="/scripts.js" ></script>
  </body>
</html>
